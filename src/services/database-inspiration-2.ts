import { createRxDatabase, addRxPlugin, RxDatabase } from 'rxdb';

import { resolve } from 'path';
import { v4 as uuidv4 } from 'uuid';
import { existsSync, mkdirSync } from 'fs';
import { USER_DATA } from '../../constants/storage';

import { schemas } from './schemas';

addRxPlugin(require('pouchdb-adapter-node-websql'));

const createConnection = async (name, collections: string[]) => {
	const cleanName = name[0].toUpperCase() + name.slice(1);

	const db = await createRxDatabase({
		name: resolve(USER_DATA, cleanName),
		adapter: 'websql',
	});

	for (const collection of collections) {
		await db.collection({
			name: collection,
			schema: schemas[collection],
		});
	}

	return db;
};

export class Storage {
	public db: RxDatabase;
	public dirs = ['themes'];

	constructor() {
		this.init();
		this.initDir();
	}

	public async get(collection: string, query: any) {
		const value = Object.values(query)[0];
		const key = Object.keys(query)[0];

		const q = this.db.collections[collection].find().where(key).eq(value);

		const results = await q.exec();

		const res = [];

		for (const r of results) {
			const document = this.getValue(r);

			res.push(document.value);
		}

		return res;
	}

	public async set(collection: string, query: any, update: any) {
		const value = Object.values(query)[0];
		const key = Object.keys(query)[0];

		const q = this.db.collections[collection].find().where(key).eq(value);

		await q.update(update);

		await q.exec();

		return true;
	}

	public async insert(collection: string, document: any) {
		if (!document.id && schemas[collection].properties.id) document.id = uuidv4();

		this.db.collections[collection].insert(document);

		return true;
	}

	public async getAll(collection: string) {
		const q = this.db.collections[collection].find();

		const results = await q.exec();

		const res = [];

		for (const r of results) {
			const document = this.getValue(r);

			res.push(document);
		}

		return res;
	}

	private getValue(queryResult: any) {
		const document = queryResult._dataSync$._value;

		delete document._rev;

		return document;
	}

	public async init() {
		this.db = await createConnection('storage', ['settings', 'history']);
	}

	public async initDir() {
		for (const dir of this.dirs) {
			if (!existsSync(resolve(USER_DATA, dir))) mkdirSync(resolve(USER_DATA, dir));
		}
	}
}
